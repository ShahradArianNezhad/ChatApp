{% extends "layout1.html" %}

{% block title %}
ChatApp
{% endblock title %}

{% block content %}
{% csrf_token %}
<div class="sidebar">
    <div class="sidebar-header">
        <h2>ChatNow</h2>
        <button id="addRoomBtn">+</button>
    </div>
    <div class="search-bar">
        <input type="text" placeholder="Search">
    </div>
    <div class="chat-list" id="chatList">
        {% for x in chatrooms %}
            {% if x.name == chatroom.name %}
                <a href="{% url "chatRoom:chatroom_detail" x.name %}" class="selected-chat-item-link">
                    <div class="chat-item">
                        <div class="chat-avatar">{{x.name.0}}{{x.name.1}}</div>
                        <div class="chat-info">
                            <div class="chat-name">{{x.name}}</div>
                        </div>
                    </div>
                </a>  
            {% else %}
                <a href="{% url "chatRoom:chatroom_detail" x.name %}" class="chat-item-link">
                    <div class="chat-item">
                        <div class="chat-avatar">{{x.name.0}}{{x.name.1}}</div>
                        <div class="chat-info">
                            <div class="chat-name">{{x.name}}</div>
                        </div>
                    </div>
                </a>  
            {% endif %}
        {% endfor %}

    </div>
</div>

<div class="chat-area">
    <div class="chat-header">
        <div class="chat-avatar">{{user.username.0}}{{user.username.1}}</div>
        <div class="chat-info">
            <div class="chat-name">{{user.username}}</div>
            <div class="chat-preview">online</div>
        </div>
    </div>
    
    <div class="chat-messages" id="chatMessages">
        {% for i in messages %}
            {% if user.username != i.sender %}
            <div class="message received">
                <div class="message-avatar">{{i.sender.0}}{{i.sender.1}}</div>
                <div class="message-content">{{i.message}}</div>
                <div class="message-time">{{i.time_sent}}</div>
            </div>
            {% else %}
            <div class="message sent">
                <div class="message-avatar">{{user.username.0}}{{user.username.1}}</div>
                <div class="message-content">{{i.message}}</div>
                <div class="message-time">{{i.time_sent}}</div>
            </div>
            {% endif %}
        
        
        
        {% endfor %}
    </div>
    
    <div class="chat-input">
        <input type="text" placeholder="Write a message...">
        <button class="send-button">âž¤</button>
    </div>
</div>

<!-- Room Modal -->
<div id="roomModal" class="modal">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h3>Room Options</h3>
        <div class="modal-options">
            <button id="joinRoomBtn" class="modal-btn">Join Room</button>
            <button id="createRoomBtn" class="modal-btn">Create Room</button>
        </div>
        
        <!-- Join Room Form (hidden by default) -->
        <div id="joinRoomForm" class="room-form" style="display: none;">
            <input type="text" id="roomCode" placeholder="Enter room name">
            <button id="confirmJoinBtn" class="confirm-btn">Join</button>
        </div>
        
        <!-- Create Room Form (hidden by default) -->
        <div id="createRoomForm" class="room-form" style="display: none;">
            <input type="text" id="roomName" placeholder="Enter room name">
            <button id="confirmCreateBtn" class="confirm-btn">Create</button>
        </div>
    </div>
</div>


<script>
    roomName="{{chatroom.name}}"
    const chatSocket = new WebSocket(
        `ws://${window.location.host}/ws/chat/${roomName}/`);


        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            
            if (data.sender=="{{user.username}}"){
                document.querySelector('#chatMessages').innerHTML += `
                <div class="message sent">
                    <div class="message-avatar">${data.sender[0]}${data.sender[1]}</div>
                    <div class="message-content">${data.message}</div>
                    <div class="message-time">${data.time_sent}</div>
                </div>
                `;}
            else{
                document.querySelector('#chatMessages').innerHTML += `
                <div class="message received">
                    <div class="message-avatar">${data.sender[0]}${data.sender[1]}</div>
                    <div class="message-content">${data.message}</div>
                    <div class="message-time">${data.time_sent}</div>
                </div>
            `;}
            scrollToBottom()
        };

        chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
        };

        
        document.querySelector('.chat-input input').onkeyup = function(e) {
            const now = new Date();
            if (e.key === 'Enter' && e.target.value.trim()!="") {
                const message = e.target.value;
                chatSocket.send(JSON.stringify({
                    'type':'chat_message',
                    'message': message,
                    'sender': '{{ request.user.username }}',
                    'time_sent':now.getHours()+":"+now.getMinutes()
                }));
                e.target.value = '';
            }

        };


        function scrollToBottom() {
            const messagesContainer = document.querySelector('#chatMessages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }




















    document.addEventListener('DOMContentLoaded', scrollToBottom);
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('roomModal');
        const addRoomBtn = document.getElementById('addRoomBtn');
        const closeModal = document.querySelector('.close-modal');
        const joinRoomBtn = document.getElementById('joinRoomBtn');
        const createRoomBtn = document.getElementById('createRoomBtn');
        const joinRoomForm = document.getElementById('joinRoomForm');
        const createRoomForm = document.getElementById('createRoomForm');
        

        const confirmCreateBtn = document.getElementById('confirmCreateBtn');


        confirmCreateBtn.addEventListener('click', function() {
            const roomName = document.getElementById('roomName').value;
            
            if (!roomName) {
                alert('Please enter a room name');
                return;
            }
    
            // Send the room name to your Django backend
            fetch('http://localhost:8000/chatRoom/create-room/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCookie('csrftoken'), // You'll need to implement getCookie
                },
                body: `room_name=${encodeURIComponent(roomName)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Close the modal
                    modal.style.display = 'none';
                    createRoomForm.style.display = 'none';
                    
                    // Clear the input
                    document.getElementById('roomName').value = '';
                    
                    // Option 1: Reload the page to show the new room
                    window.location.reload();
                    
                    // Option 2: Dynamically add the new room to the sidebar
                    // addRoomToSidebar(data.room_name, data.room_id);
                } else {
                    alert(data.message || 'Error creating room');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error creating room');
            });
        });




        const confirmJoinBtn = document.getElementById('confirmJoinBtn');


        confirmJoinBtn.addEventListener('click', function() {
            const roomCode = document.getElementById('roomCode').value;
            
            if (!roomCode) {
                alert('Please enter a room name');
                return;
            }
    
            // Send the room name to your Django backend
            fetch('http://localhost:8000/chatRoom/join-room/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCookie('csrftoken'), // You'll need to implement getCookie
                },
                body: `room_name=${encodeURIComponent(roomCode)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Close the modal
                    modal.style.display = 'none';
                    createRoomForm.style.display = 'none';
                    
                    // Clear the input
                    document.getElementById('roomCode').value = '';
                    
                    // Option 1: Reload the page to show the new room
                    window.location.reload();
                    
                    // Option 2: Dynamically add the new room to the sidebar
                    // addRoomToSidebar(data.room_name, data.room_id);
                } else {
                    alert(data.message || 'Error creating room');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error creating room');
            });
        });




    
        // Helper function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        





        addRoomBtn.addEventListener('click', function() {
            modal.style.display = 'block';
        });
        

        closeModal.addEventListener('click', function() {
            modal.style.display = 'none';
            joinRoomForm.style.display = 'none';
            createRoomForm.style.display = 'none';
        });
        

        joinRoomBtn.addEventListener('click', function() {
            joinRoomForm.style.display = 'block';
            createRoomForm.style.display = 'none';
        });

        createRoomBtn.addEventListener('click', function() {
            createRoomForm.style.display = 'block';
            joinRoomForm.style.display = 'none';
        });
        

        window.addEventListener('click', function(event) {
            if (event.target == modal) {
                modal.style.display = 'none';
                joinRoomForm.style.display = 'none';
                createRoomForm.style.display = 'none';
            }
        });

    });
</script>
{% endblock content %}